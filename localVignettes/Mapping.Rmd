---
title: "Mapping"
author: "Alice Yang"
date: "1/27/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In the summer of 2015 we had catastrophic wildfires in Washington state, whilch then led to heavy smoke in the
surrounding towns for quite a few days. Visualizing smoke data can have vital importance by helping
us understand patterns of wildfire consequences.

In this report, we would like to show how our mapping functions in the PWFSLSmoke package can help us visualize the PM25 data from summer of 2015. To begin, let's have a broader look in the regions of Washington, Oregon and Idaho from June 1, 2015 to October 31m 2015.

```{r, message=FALSE}
library(PWFSLSmoke)
airnow <- airnow_load(startdate = 20150601, enddate = 20151031)
airnow <- monitor_subset(airnow, stateCodes = c("WA", "OR", "ID"), countryCodes = "US")
monitorMap(airnow)
monitorLeaflet(airnow)
```

The monitorMap plot and monitorLeaflet plot show us pretty much the same information, except that from
leaflet plot you can get information of a paticular monitor by clicking on the dot of interest. Now
we might be interested to see which specific location has the worst acute smoke.

```{r}
worstPm25 <- max(airnow$data[,-1], na.rm=TRUE)
worstMonitor <- which(airnow$data==worstPm25, arr.ind=TRUE)
worstAcuteMonitor <- colnames(airnow$data)[worstMonitor[2]]
airnow$meta[,c(3,8,9,10,12,17,18,20)][which(airnow$meta$monitorID==worstAcuteMonitor),]
```

So we find out that the location where monitor "160491012" resides had worst acute PM2.5 among all other places during that summer. From our meta-data we know this is in Latah county in Idaho. 

We might also be interested in finding out which location had the worst chronic air quality. We can find out the answer by comparing the number of unhealthy days on average by AQI standard. 

```{r}
airnowAvg <- suppressWarnings(monitor_dailyStatistic(airnow))
numBadDays <- apply(airnowAvg$data[,-1], 2, function(x){ sum(x > AQI$breaks_24[4], na.rm=TRUE) }) #unhealthy level
worstChronicMonitor <- colnames(airnowAvg$data)[which(numBadDays==max(numBadDays))+1]
airnow$meta[,c(3,8,9,10,12,17,18,20)][which(airnow$meta$monitorID==worstAcuteMonitor),]
```

So we know that the Idaho county in Idaho had the worst chronic air quality during summer 2015. 

With the worst acute and worst chronic counties, we can see how they locate relatively on the map:

```{r}
monitorMap(airnow)
points(-116.709, 46.57873,cex=1.8,pch=1,lwd=2,col="blue")
points(-116.0275, 46.2094, cex=1.8,pch=1,lwd=2,col="darkgreen")
```

The dot with blue outline is the worst acute location, the dot with dark green outline is the worst chronic location.

Or we can use a flame instead of a circle to mark these two locations on the map to make it look a little more intuitive.

```{r}
monitorMap(airnow)
addIcon("orangeFlame", -116.709, 46.57873, expansion=0.0018, pos=3)
addIcon("redFlame", -116.0275, 46.2094, expansion=0.0018, pos=3)
```

As you can see the orange flame is where we had worst acute smoke and the red flame is where we had the worst chronic smoke

Since we now know the locations with the worst acute and chronic air quality, we can look at their daily average bar plots to see which days had really bad smoke. 

```{r}
monitorPlot_dailyBarplot(ws_monitor=airnow, monitorID=worstAcuteMonitor) #0817 0829
monitorPlot_dailyBarplot(ws_monitor=airnow, monitorID=worstChronicMonitor) #0811 0829
```

We can see the unhealthy days are approximately from August 17 to August 29 for the worst acute location, and from August 11 to August 29 for the worst Chronic location. These dates also imply that the smoke came from the Okanogan Complex Fire. Then we can further zoon in to see the hourly averahe barplot to figure out if there's any pattern of the smoke during a day.

```{r}
monitorPlot_hourlyBarplot(ws_monitor=airnow, monitorID=worstAcuteMonitor, tlim=c(20150822, 20150827))
monitorPlot_hourlyBarplot(ws_monitor=airnow, monitorID=worstChronicMonitor, tlim=c(20150822, 20150827))
```

It's easy to see that at the worst acute location, the smoke spiked at around noon from August 23 to August 26. And there's no consistent pattern for smoke at the worst chronic location. We can further confirm our observations in the below spaghetti plots.

```{r}
monitorPlot_timeOfDaySpaghetti(ws_monitor=airnow, monitorID=worstAcuteMonitor, tlim=c(20150822, 20150827))
monitorPlot_timeOfDaySpaghetti(ws_monitor=airnow, monitorID=worstChronicMonitor, tlim=c(20150822, 20150827))
```

The spaghetti plot for the worst acute location echos what we discovered in the hourly plot. For the spaghetti plot
of the worst chronic location, the lines are kind of bouncing up and down in the afternoon.

Finally we can zoon out to have a bigger picture of the number of unhealthy days by AQI standard among all the counties.

```{r}
numBadDaysCounty <- aggregate(data.frame(numBadDays), list(airnow$meta$GNISCountyCode), max) 
numBadDaysCounty[,2] <- ceiling(numBadDaysCounty[,2])
colnames(numBadDaysCounty) <- c("fips", "days")
countyFIPs <- maps::county.fips
countyFIPs <- countyFIPs[!duplicated(countyFIPs[,1]),]
countyFIPs$polyname <- sapply(countyFIPs$polyname,function(x){ return( stringr::str_split_fixed(x,":",2)[1] ) } )
numBadDaysCounty <- data.frame(apply(numBadDaysCounty,2,as.integer))
numBadDaysCounty <- dplyr::left_join(numBadDaysCounty, countyFIPs, by="fips")
colnames(numBadDaysCounty)[3] <- "county"
# days' breaks: 0, 1-5, 6-10, 11-15, 16-20
numBadDaysCounty$colIndex <- .bincode(numBadDaysCounty$days, c(0,1,5,10,15,20), right=FALSE)
cols <- RColorBrewer::brewer.pal(11, "BrBG")[5:1]

map("county",c("WA","OR","ID"))
for(i in 1:nrow(numBadDaysCounty)) {
  map("county", numBadDaysCounty$county[i], col=cols[numBadDaysCounty$colIndex[i]], fill=TRUE, add=TRUE)
}
legend("topright", title="Unhealthy Days", pch=16, pt.cex=1.5, col=cols, legend=c("0", "1-5", "6-10", "11-15", "16-20"), bty="n")
```

We can see that the Idaho county in Idaho is the county that had most of bad smokey days while the Okanogan county in Washington had the second most of bad smokey days.