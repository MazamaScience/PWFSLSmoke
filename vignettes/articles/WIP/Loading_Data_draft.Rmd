---
title: "Loading Data"
author: "Mazama Science"
date: "2021-02-19"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Data Model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE}
knitr::opts_chunk$set(fig.width = 7, fig.height = 5)
knitr::opts_chunk$set(error = TRUE)
```
```{r libraries, echo = FALSE, eval=TRUE, warning=FALSE, message=FALSE}
library(dplyr)
library(PWFSLSmoke)
library(magrittr)
```

## Welcome to the data archive

### Temporary and permant monitors

The [data archive](https://haze.airfire.org/monitoring/) hosts PM2.5 data 
generated by temporary and permanent monitors. The agencies providing this data 
are: [AIRSIS](https://app.airsis.com/USFS) and [WRCC](http://www.wrcc.dri.edu) 
(Western Regional Climate Cente) - temporary monitors; [
AirNow](https://www.airnow.gov) - permanet monitors. 

### Four types of archive files — hourly, daily, monthly, and annual 

The data archive is maintained by [PWFSL](https://www.fs.usda.gov/pnw/research-labs/pacific-wildland-fire-sciences-laboratory-seattle) 
(Pacific Wildland Fire Sciences Lab) and, for each agency, the 
archive offers datasets updated hourly, daily, and annually. Additionally, 
Airnow includes datasets updated monthly. Following, an explanation of the 
methods used to update the different files: 

* the hourly files are updated multiple times an hour (~ every two minutes) and 
contain data for the previous 10 days. 

* the daily files are updated once a day, shortly after midnight and contain 
data for the previous 45 days.

* the monthly files are updated within a few days after the 10'th of the 
following month. For instance, July is updated on August. 

* the annual files are updated within a few days after the 10'th of each month 
and cover the period from the beginning of the year to the end of the last month. 
 
*NOTE*: the date and time of annual and monthly updates are subject to change. 
The exact date and time is availabe next to file of interest, under the column 
`Last modified`. For instance, [here](https://haze.airfire.org/monitoring/WRCC/RData/2017/) you can see that 
the file `wrcc_PM2.5_2021.RData` was generated on February 14, 2021 at 01:24 am. 

### Structure of the archive

The data archive is structured as follow:

* at the first level, there is a dedicated frolder for each agency (i.e [AIRSIS](https://haze.airfire.org/monitoring/AIRSIS/), 
[AirNow](https://haze.airfire.org/monitoring/AirNow/),
[WRCC](https://haze.airfire.org/monitoring/WRCC/)). Additionally, at this level,
latest data (hourly and daily updates) for all agencies is grouped together and 
can be quicly accessed  from the [latest/RData](https://haze.airfire.org/monitoring/latest/RData/) subdirectory.

* at the second level, each agency has the `RData/` folder (e.g. AirNow/RData/).

* at the third level, each agency has annual folders (e.g. AirNow/RData/2021/) 
and the `latest/` folder (e.g. AirNow/RData/latest/). The latter contains hourly
(e.g. airnow_PM2.5_latest10.RData) and daily (e.g. airnow_PM2.5_latest45.RData) 
data. 

* at the fourth level, each agency has annual datasets 
(e.g. airnow_PM2.5_2021.RData). Additionally, AirNow has monthly folders (e.g. AirNow/RData/2021/01/), and 
therefore a fith level containing monthly datasets 
(e.g. airNow_PM2.5_2021_01.RData). 

*NOTE*: PWFSL has no annual data files for AirNow prior to 2016.

### Loading files directly from the data archive

It is possible to load datasets from the data archive and save it as an object 
in the R environment by using `get(load(url(…)))`. For instance, if you want to 
load the latest data (hourly updates) from AirNow, you can use the following 
script: 
```{r, example for loading data, eval=FALSE}
AirNow_h = get(load(url("https://haze.airfire.org/monitoring/latest/RData/airnow_PM2.5_latest10.RData")))
```


## PWFSLSmoke loading functions

For each agency (AirNow, AIRSIS, WRCC), the [PWFSLSmoke package](http://mazamascience.github.io/PWFSLSmoke/reference/index.html) offers 
three loading functions: 

* `~loadLatest` - for hourly data 
```{r, example loadLatest , eval=FALSE}
airnow_loadLatest(
parameter = 'PM2.5',
baseUrl = "https://haze.airfire.org/monitoring/latest/RData",
dataDir = NULL) 
```

* `~loadDaily` - for daily updates covering the most recent 45 days
```{r, example loadDaily, eval=FALSE}
airnow_loadDaily(
parameter = 'PM2.5',
baseUrl = "https://haze.airfire.org/monitoring/latest/RData",
dataDir = NULL) 
```

* `~loadAnnual` - for data extended more than 45 days into the past 
```{r, example loadAnnual, eval=FALSE}
airnow_loadAnnual(
year = NULL,
parameter = 'PM2.5',
baseUrl = "https://haze.airfire.org/monitoring",
dataDir = NULL) 
```


Unless the argument `dataDir` is specified, the data will be loaded from the [archive](https://haze.airfire.org/monitoring). 


The preferred function for general data loading is [monitor_load()](http://mazamascience.github.io/PWFSLSmoke/reference/monitor_load.html), which loads monitoring data for a given time range. Data from AirNow, AIRSIS and
WRCC are combined into a single *ws_monitor* object. Archival datasets are 
joined with 'daily' and 'latest' datasets as needed to satisfy the requested 
date range.
```{r, monitor_load(), eval=FALSE}
monitor_load(
  startdate = NULL,
  enddate = NULL,
  monitorIDs = NULL,
  parameter = "PM2.5",
  baseUrl = "https://haze.airfire.org/monitoring",
  dataDir = NULL,
  aqsPreference = "airnow"
)
```

*NOTE*: the PWFSLSmoke package does not _yet_ allow to cross year boundaries 
because “joining” timeseries together can take a long time. This capability will
be enabled at some point in the future.

## Examples using PWFSLSmoke loading functions

#### Timeseries plot created by loading the latest data for Washington State 

```{r, loadLatest WA, eval=FALSE, warning=FALSE}
airnow_loadLatest() %>%
  monitor_subset(stateCodes= 'WA') %>%
  monitor_timeseriesPlot(style = 'gnats', ylim=c(0,150), xpd=NA)
  addAQIStackedBar()
  addAQILines()
  title("Washington State 2021 -- AirNow Latast Average PM2.5")
```

#### Timeseries plot created by loading annual data (2015) for Oregon, Idaho, and Washington State. 

```{r, OR_ID_WA airsis_loadAnnual(2015), eval=FALSE, warning=FALSE}
OR_ID_WA = airsis_loadAnnual(2015) %>%
  monitor_subset(stateCodes= c("OR", "ID", "WA"))%>%
  monitor_timeseriesPlot(style = 'gnats', ylim=c(0,300), xpd=NA)
addAQIStackedBar()
addAQILines()
title("OR-ID-WA 2015 -- AirNow Annual Average PM2.5")
```

```{r, OR_ID_WA monitor_load(20150101, 20151231), echo=FALSE, include=FALSE}
# this takes too long. R got stuck 
# OR_ID_WA = monitor_load(20150101, 20151231) %>%
#   monitor_subset(stateCodes= c("OR", "ID", "WA"))%>%
#   monitor_timeseriesPlot(style = 'gnats', ylim=c(0,300), xpd=NA)
# addAQIStackedBar()
# addAQILines()
# title("OR-ID-WA 2015 -- AirNow Annual Average PM2.5")
```
