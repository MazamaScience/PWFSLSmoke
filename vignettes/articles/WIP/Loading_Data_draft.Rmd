---
title: "Loading Data"
author: "Mazama Science"
date: "2021-02-17"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Data Model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE}
knitr::opts_chunk$set(fig.width = 7, fig.height = 5)
knitr::opts_chunk$set(error = TRUE)
```
```{r libraries, echo = FALSE, eval=TRUE, warning=FALSE, message=FALSE}
library(dplyr)
library(PWFSLSmoke)
library(magrittr)
```

## Welcome to the data archive

### WIP: temporary monitors (WRCC, AIRSIS) vs. permanent monitors (AirNow)

The [data archive](https://haze.airfire.org/monitoring/) hosts PM2.5 data generated by temporary and permanent monitors. The agencies providing this data are: [AIRSIS](https://app.airsis.com/USFS) and [WRCC](http://www.wrcc.dri.edu)(Western Regional Climate Cente), with temporary monitors; [AirNow](https://www.airnow.gov)) with permanet monitors. 

### WIP: three types of archive files — hourly, daily, monthly, 

Each agency provides hourly, daily, and annual data. Additionally, Airnow provides montly data. Following, an explanation of the methods used to update the different files:
* the hourly files are updated multiple times an hour (every two minutes) and contain data for the previous 10 days. 
* the daily files are updated once a day, shortly after midnight and contain data for the previous 45 days.
* the monthly files are updated within a few days after the 10'th of the following month. For instance, July is updated on August. 
* the annual files are updated on the 15'th of each month and cover the period from the beginning of the year to the end of the last month. 
 
*NOTE*: the date and time of annual and monthly data are subject to change. The exact date and time is availabe next to file of interest, under the column `Last modified`. For instance, [here](https://haze.airfire.org/monitoring/WRCC/RData/2017/) you can see that the file `wrcc_PM2.5_2021.RData` was generated on February 14, 2021 at 01:24 am. 

### WIP: structure of the archive
The data archive is structured as follow:
* at the first level, each agency has its own folder (i.e [AIRSIS](https://haze.airfire.org/monitoring/AIRSIS/), [AirNow](https://haze.airfire.org/monitoring/AirNow/), [WRCC](https://haze.airfire.org/monitoring/WRCC/)). Additionally, at this level, latest data (hourly and daily) from all agencies is grouped together and can be quicly accessed  from the [latest/RData](https://haze.airfire.org/monitoring/latest/RData/) subdirectory.
* at the second level, each agency has the `RData/` folder.
* at the third level, each agency has yearly folders (e.g. `2010/`) and the `latest/` folder. The latter contains hourly (e.g. `agencyName_PM2.5_latest10.RData`) and daily (e.g. `agencyName_PM2.5_latest45.RData`) data. 
* at the fourth level, each agency has annual data (e.g. `agencyName_PM2.5_2019.RData`). Additionally, AirNow has monthly folders (e.g. `01/`), and therefore a fith level containing monthly data (e.g. AirNow_PM2.5_2018_06.RData).

### loading files directly from the archive with get(load(url(…)))
It is possible to load the data archive and save it as an object in the R environment by using `get(load(url(…)))`. For instance, if I want to load the hourly data from AirNow, I will use the following script: 
```{r, example for loading data, eval=FALSE}
AirNow_h = get(load(url("https://haze.airfire.org/monitoring/latest/RData/airnow_PM2.5_latest10.RData")))
```



## Loading functions. 
* TO DO: 
For each agency (AirNow, AIRSIS, WRCC), the [PWFSLSmoke package](http://mazamascience.github.io/PWFSLSmoke/reference/index.html) offers three loading functions: 

* `~loadLatest` - for hourly data 
```{r, example loadLatest , eval=FALSE}
airnow_loadLatest(
parameter = 'PM2.5',
baseUrl = "https://haze.airfire.org/monitoring/latest/RData",
dataDir = NULL) 
```


* `~loadDaily` - for daily updates covering the most recent 45 days
```{r, example loadDaily, eval=FALSE}
airnow_loadDaily(
parameter = 'PM2.5',
baseUrl = "https://haze.airfire.org/monitoring/latest/RData",
dataDir = NULL) 
```

* `~loadAnnual` - data extended more than 45 days into the past 
```{r, example loadAnnual, eval=FALSE}
airnow_loadAnnual(
year = NULL,
parameter = 'PM2.5',
baseUrl = "https://haze.airfire.org/monitoring",
dataDir = NULL) 
```


Unless the argument `dataDir` is specified, data will be loaded from the [archive](https://haze.airfire.org/monitoring), which is maintained by [PWFSL](https://www.fs.usda.gov/pnw/research-labs/pacific-wildland-fire-sciences-laboratory-seattle) (Pacific Wildland Fire Sciences Lab). 


The preferred function for general data loading is [monitor_load()](http://mazamascience.github.io/PWFSLSmoke/reference/monitor_load.html), which loads monitoring data for a given time range. Data from AirNow, AIRSIS and WRCC are combined into a single *ws_monitor* object. Archival datasets are joined with 'daily' and 'latest' datasets as needed to satisfy the requested date range.
```{r, monitor_load(), eval=FALSE}
monitor_load(
  startdate = NULL,
  enddate = NULL,
  monitorIDs = NULL,
  parameter = "PM2.5",
  baseUrl = "https://haze.airfire.org/monitoring",
  dataDir = NULL,
  aqsPreference = "airnow"
)
```


* TO DO: note — no ability to cross year boundaries (OK because there are few wildfires on New Year’s Eve) ??????????


## examples
* TO DO: most current example -- load and create plot the using Latest data for Washington
```{r, loadLatest WA, echo=FALSE}
airnow_loadLatest() %>%
  monitor_subset(stateCodes= 'WA') %>%
  monitor_dailyStatistic() %>%
  monitor_timeseriesPlot(style = 'gnats', ylim=c(0,50), xpd=NA)
  addAQIStackedBar()
  addAQILines()
  title("Washington State 2021 -- AirNow Latast Average PM2.5")
```



* TO DO: archival example — load and create plot using data from OR-ID-WA during 2015 (this is the package dataset Northwest Megafires but obtain the data from the archive)
