<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NowCast • PWFSLSmoke</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="NowCast">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">PWFSLSmoke</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.2.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/PWFSLSmoke.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Data_Model.html">Data Model</a>
    </li>
    <li>
      <a href="../articles/Maps_and_Timeseries_Plots.html">Maps and Timeseries Plots</a>
    </li>
    <li>
      <a href="../articles/NowCast.html">NowCast</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MazamaScience/PWFSLSmoke">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>NowCast</h1>
                        <h4 class="author">Mazama Science</h4>
            
            <h4 class="date">4/3/2019</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MazamaScience/PWFSLSmoke/blob/master/vignettes/NowCast.Rmd"><code>vignettes/NowCast.Rmd</code></a></small>
      <div class="hidden name"><code>NowCast.Rmd</code></div>

    </div>

    
    
<p>This vignette documents the <code><a href="../reference/monitor_nowcast.html">monitor_nowcast()</a></code> function, which converts a <code>ws_monitor</code> object’s values to NowCast values. We provide details on the NowCast algorithm and our implementation thereof. We also provide examples to highlight specific attributes and potential points of confusion in the algorithm.</p>
<p>This vignette also briefly covers the <code><a href="../reference/monitor_aqi.html">monitor_aqi()</a></code> function, which uses the <code><a href="../reference/monitor_nowcast.html">monitor_nowcast()</a></code> function to convert raw PM2.5 data into NowCast-based AQI values.</p>
<div id="what-is-nowcast" class="section level2">
<h2 class="hasAnchor">
<a href="#what-is-nowcast" class="anchor"></a>What is NowCast?</h2>
<p>NowCast is an air quality data smoothing algorithm that puts an emphasis on recent values when measurements are unstable, and approaches a long-term (<em>e.g.</em> 12-hour) average when measurements are stable.</p>
<p>The original algorithm, known as the Conroy method, was developed in 2003 to make real-time air quality measurements roughly comparable to established regulatory air quality health thresholds (<em>e.g.</em> 24‐hour PM2.5 standards). However, that method was shown to be slow to respond to rapidly changing air quality conditions, which, at best, reduced public confidence in disseminated AQI values, and at worst, had the potential to adversely affect the health of those in high impact areas (<em>e.g.</em> near wildfires).</p>
<p>In response, EPA developed a new method – the Reff method – in 2013 to be more responsive to rapidly changing air quality conditions. We provide technical support for applying the new NowCast algorithm to hourly PM2.5, PM10, and O3 data, though theoretically it could be applied to regular-interval time series data of any type, including other criteria pollutants.</p>
<p>We provide algorithm specifics for PM2.5, PM10, and O3 below.</p>
Sources:<br><a href="https://www3.epa.gov/airnow/ani/pm25_aqi_reporting_nowcast_overview.pdf" class="uri">https://www3.epa.gov/airnow/ani/pm25_aqi_reporting_nowcast_overview.pdf</a><br><pre>https://forum.airnowtech.org/t/the-nowcast-for-ozone-and-pm/172</pre>
</div>
<div id="the-nowcast-algorithm-reff-method" class="section level2">
<h2 class="hasAnchor">
<a href="#the-nowcast-algorithm-reff-method" class="anchor"></a>The NowCast Algorithm (Reff Method)</h2>
<div id="nowcast-equation" class="section level3">
<h3 class="hasAnchor">
<a href="#nowcast-equation" class="anchor"></a>NowCast Equation</h3>
<p>The NowCast value for a given hour can be calculated as follows:</p>
<p><span class="math display">\[
NowCast = \frac{\sum_{i=1}^{N}{w^{i-1}c_i}}{\sum_{i=1}^{N}w^{i-1}}
\]</span></p>
<p>where <span class="math inline">\(i\)</span>, <span class="math inline">\(N\)</span>, <span class="math inline">\(w\)</span> and <span class="math inline">\(c\)</span> are as defined in the sections below.</p>
<p>Sources:<br><a href="https://en.wikipedia.org/wiki/NowCast_(air_quality_index)" class="uri">https://en.wikipedia.org/wiki/NowCast_(air_quality_index)</a><br><a href="https://www3.epa.gov/airnow/ani/pm25_aqi_reporting_nowcast_overview.pdf" class="uri">https://www3.epa.gov/airnow/ani/pm25_aqi_reporting_nowcast_overview.pdf</a></p>
</div>
<div id="data-selection" class="section level3">
<h3 class="hasAnchor">
<a href="#data-selection" class="anchor"></a>Data Selection</h3>
<p>The NowCast algorithm uses hourly averages from the prior <span class="math inline">\(N\)</span> clock hours, where the value of <span class="math inline">\(N\)</span> depends on the pollutant being processed:</p>
<ul>
<li>
<strong>PM2.5</strong>: <span class="math inline">\(N = 12\)</span>
</li>
<li>
<strong>PM10</strong>: <span class="math inline">\(N = 12\)</span>
</li>
<li>
<strong>O3</strong>: <span class="math inline">\(N = 8\)</span>
</li>
</ul>
<p>The hourly averages are denoted below by <span class="math inline">\(c_i\)</span>, where <span class="math inline">\(i\)</span> represents the number of hours before present. For example, <span class="math inline">\(c_1\)</span>, <span class="math inline">\(c_2\)</span>, <span class="math inline">\(c_3\)</span>, <span class="math inline">\(...\)</span>, <span class="math inline">\(c_N\)</span> represent the hourly averages for the most recent 1, 2, 3, <span class="math inline">\(...\)</span>, <span class="math inline">\(N\)</span> hours.</p>
Source:<br><pre>https://forum.airnowtech.org/t/the-nowcast-for-ozone-and-pm/172</pre>
</div>
<div id="weight-factor" class="section level3">
<h3 class="hasAnchor">
<a href="#weight-factor" class="anchor"></a>Weight Factor</h3>
<p>Using the <span class="math inline">\(N\)</span> data points specified above, define the weight factor <span class="math inline">\(w^*\)</span> as follows:</p>
<p><span class="math display">\[
w^* = 1- \frac{c_{max}-c_{min}}{c_{max}} = \frac{c_{min}}{c_{max}}
\]</span></p>
<p>where</p>
<ul>
<li>
<span class="math inline">\(c_{max}\)</span> = the highest value in <span class="math inline">\(c_1\)</span>, <span class="math inline">\(...\)</span>, <span class="math inline">\(c_N\)</span>
</li>
<li>
<span class="math inline">\(c_{min}\)</span> = the lowest value in <span class="math inline">\(c_1\)</span>, <span class="math inline">\(...\)</span>, <span class="math inline">\(c_N\)</span>
</li>
</ul>
<p>NowCast-related literature usually gives the equation for <span class="math inline">\(w^*\)</span> in one of two basic forms, both of which are included above for reference. Note that both forms are equivalent.</p>
Sources:<br><a href="https://en.wikipedia.org/wiki/NowCast_(air_quality_index)" class="uri">https://en.wikipedia.org/wiki/NowCast_(air_quality_index)</a>
<pre>https://forum.airnowtech.org/t/the-nowcast-for-ozone-and-pm/172</pre>
</div>
<div id="minimum-weight-factor" class="section level3">
<h3 class="hasAnchor">
<a href="#minimum-weight-factor" class="anchor"></a>Minimum Weight Factor</h3>
<p>Before plugging into the NowCast equation, <span class="math inline">\(w*\)</span> is updated to <span class="math inline">\(w\)</span> for PM2.5 and PM10 as follows:</p>
<p><span class="math display">\[
w = 
\begin{cases}
w^*         &amp; \text{if} &amp; w^*&gt;\frac{1}{2} \\
\frac{1}{2} &amp; \text{if} &amp; w^*\leq \frac{1}{2}  \\
\end{cases}
\]</span></p>
<p>For O3, there is no minimum weight factor, so we define <span class="math inline">\(w = w^*\)</span></p>
Source:<br><pre>https://forum.airnowtech.org/t/the-nowcast-for-ozone-and-pm/172</pre>
</div>
<div id="truncation" class="section level3">
<h3 class="hasAnchor">
<a href="#truncation" class="anchor"></a>Truncation</h3>
<p>Final NowCast values are truncated based on the type of data being processed:</p>
<ul>
<li>
<strong>PM2.5</strong>: 0.1 µg/m3</li>
<li>
<strong>PM10</strong>: 1 µg/m3</li>
<li>
<strong>O3</strong>: 1 ppb (0.001 ppm)</li>
</ul>
Source:<br><pre>https://forum.airnowtech.org/t/the-nowcast-for-ozone-and-pm/172</pre>
</div>
</div>
<div id="algorithm-expansion" class="section level2">
<h2 class="hasAnchor">
<a href="#algorithm-expansion" class="anchor"></a>Algorithm Expansion</h2>
<p>For PM2.5, which uses 12 hours of data, the NowCast equation can be expanded as follows:</p>
<p><span class="math display">\[
NowCast = \frac
{w^0c_1 + w^1c_2 + w^2c_3 + w^3c_4 + w^4c_5 + w^5c_6 + w^6c_7 + w^7c_8 + w^8c_9 + w^9c_{10} + w^{10}c_{11} + w^{11}c_{12}}
{w^0 + w^1 + w^2 + w^3 + w^4 + w^5 + w^6 + w^7 + w^8 + w^9 + w^{10} + w^{11}}
\]</span></p>
<p>Note that:</p>
<ul>
<li>
<span class="math inline">\(w^0\)</span>, <span class="math inline">\(w^1\)</span>, <span class="math inline">\(w^2\)</span>, <span class="math inline">\(...\)</span> represent <span class="math inline">\(w\)</span> to the power of 0, 1, 2, <span class="math inline">\(...\)</span>
</li>
<li>
<span class="math inline">\(c_1\)</span>, <span class="math inline">\(c_2\)</span>, <span class="math inline">\(c_3\)</span>, <span class="math inline">\(...\)</span> represent the hourly average for the most recent 1, 2, 3, <span class="math inline">\(...\)</span> hours.</li>
</ul>
<p>When written this way, it is easy to see that in the extreme case where <span class="math inline">\(w = 1\)</span> (i.e. if <span class="math inline">\(c_{min} = c_{max}\)</span>) the equation above reduces to:</p>
<p><span class="math display">\[
NowCast = \frac{\sum_{i=1}^{12}{c_i}}{12}
\]</span></p>
<p>which is just a simple 12-hour arithmetic average. Incidentally, all 12 hourly averages and the 12-hour average itself would all be equivalent in this case.</p>
<p>In the case of highly variable PM2.5 data, <span class="math inline">\(w\)</span> would be set to the minimum value of <span class="math inline">\(1/2\)</span>, and the most recent data would carry the majority of the weight in the equation above.</p>
</div>
<div id="implementation-details" class="section level2">
<h2 class="hasAnchor">
<a href="#implementation-details" class="anchor"></a>Implementation Details</h2>
<div id="missing-data" class="section level3">
<h3 class="hasAnchor">
<a href="#missing-data" class="anchor"></a>Missing Data</h3>
<p>The NowCast algorithm ignores terms corresponding to hours for which a valid observation is not available. For example, suppose PM2.5 is invalid for all but the first three and last three hours of a 12-hour period. Then the PM2.5 NowCast equation takes the following form:</p>
<p><span class="math display">\[
NowCast = \frac
{w^0c_1 + w^1c_2 + w^2c_3 + \color{gray}{\text{[note: middle values ignored]}} + w^9c_{10} + w^{10}c_{11} + w^{11}c_{12}}
{w^0 + w^1 + w^2 + \color{gray}{\text{[note: middle values ignored]}} + w^9 + w^{10} + w^{11}}
\]</span></p>
<p>Minimum data availability requirements do apply, however. See the following section for details.</p>
<p>Source:<br><a href="https://www3.epa.gov/airnow/ani/pm25_aqi_reporting_nowcast_overview.pdf" class="uri">https://www3.epa.gov/airnow/ani/pm25_aqi_reporting_nowcast_overview.pdf</a></p>
</div>
<div id="data-availability-requirements" class="section level3">
<h3 class="hasAnchor">
<a href="#data-availability-requirements" class="anchor"></a>Data Availability Requirements</h3>
<p>To get a valid NowCast value, the NowCast algorithm simply requires valid data for at least two of the three most recent clock hours. This means that a valid NowCast value can be calculated from as little as two valid hours, even if 12 hours are typically used in the calculation.</p>
<p>Source:<br><a href="https://www3.epa.gov/airnow/ani/pm25_aqi_reporting_nowcast_overview.pdf" class="uri">https://www3.epa.gov/airnow/ani/pm25_aqi_reporting_nowcast_overview.pdf</a></p>
<p>However, note that <a href="https://en.wikipedia.org/wiki/NowCast_(air_quality_index)" class="uri">https://en.wikipedia.org/wiki/NowCast_(air_quality_index)</a> says:</p>
<blockquote>
<p>Because the most recent hours of data are weighted so heavily in the NowCast when PM levels are changing, EPA does not report the NowCast when data is missing for c<sub>1</sub> or c<sub>2</sub>.</p>
</blockquote>
<p>While this seems like a reasonable approach, we could not find a source for this statement (in the Wikipedia page sources or elsewhere). We take a compromise approach and still allow valid NowCast values to be calculated when c<sub>2</sub> is invalid but return <code>NA</code> when c<sub>1</sub> is invalid.</p>
</div>
<div id="argument-includeshortterm" class="section level3">
<h3 class="hasAnchor">
<a href="#argument-includeshortterm" class="anchor"></a>Argument: <code>includeShortTerm</code>
</h3>
<p>As mentioned above, the NowCast algorithm only requires two valid hours to calculate valid values. Does this mean that the <code><a href="../reference/monitor_nowcast.html">monitor_nowcast()</a></code> function can begin reporting valid values after the second hour in the data (assuming the first two hours are both valid)?</p>
<p>We assert that it would be inappropriate to do so, <em>usually</em>.</p>
<p>In most cases a user will have created a ws_monitor object using one of the <code>~_createMonitorObject()</code> or <code>~_load()</code>, functions, which return data for a specific period of time. Data before this period is not necessarily invalid, it was simply not retrieved. But the function itself has no way of knowing whether such earlier data exists, so it has no choice but to consider earlier hours “invalid”. This means that, if followed by-the-book, the NowCast algorithm could return different values for a given hour depending on whether or not the earlier data had been retrieved. This is not a desirable behavior, so by default the <code><a href="../reference/monitor_nowcast.html">monitor_nowcast()</a></code> returns invalid NowCast values until the <span class="math inline">\(N\)</span><sup>th</sup> hour of data.</p>
<p>However, we provide a manual override in <code>includeShortTerm=TRUE</code> which causes the function to return valid values as per the bare-bones data availability requirements described above, treating the hours before the beginning of the data as invalid. Thus, it can return “valid” NowCast values as early as the second (valid) hour in the data.</p>
<p>This argument may be useful (or even appropriate) for datasets where the beginning of the data truly corresponds to the beginning of the monitoring, such as when a new monitor has just been installed. In this case, data prior to the first hour is truly invalid since it does not exist. The argument may also be useful for field personnel looking to ensure that their monitor has been successfully plugged in to the data processing pipeline, even if the values themselves are not truly representative of the data for the past <span class="math inline">\(N\)</span> hours.</p>
</div>
<div id="negative-values" class="section level3">
<h3 class="hasAnchor">
<a href="#negative-values" class="anchor"></a>Negative Values</h3>
<p>In the NowCast literature we find no mention of negative values, which, while aphysical, are common in air quality monitoring data (see <a href="https://www3.epa.gov/ttn/amtic/files/2014conference/monpmpart3.pdf" class="uri">https://www3.epa.gov/ttn/amtic/files/2014conference/monpmpart3.pdf</a>). Thus, we do not adjust negative values up to zero in the <code><a href="../reference/monitor_nowcast.html">monitor_nowcast()</a></code> function itself. However, note that this may be done when creating a <code>ws_monitor</code> object in the first place.</p>
<p>Negative values are handled prior to converting NowCast or other values to AQI.</p>
</div>
<div id="negative-weight-factors" class="section level3">
<h3 class="hasAnchor">
<a href="#negative-weight-factors" class="anchor"></a>Negative Weight Factors</h3>
<p>While PM2.5 and PM10 have minimum weight factors of <span class="math inline">\(1/2\)</span>, there is no minimum weight factor for O3. Does this mean O3 could have negative weight factors? We find no mention of this in the NowCast literature; however, we assume <span class="math inline">\(w_{min}\)</span> cannot be negative since otherwise the calculation could become overwhelmed by outrageous weight factors, even as large as negative infinity (e.g. if <span class="math inline">\(c_{min}&lt;0\)</span> and <span class="math inline">\(c_{max}=0\)</span>). This assumption is built into our <code><a href="../reference/monitor_nowcast.html">monitor_nowcast()</a></code> function.</p>
</div>
<div id="argument-version" class="section level3">
<h3 class="hasAnchor">
<a href="#argument-version" class="anchor"></a>Argument: <code>version</code>
</h3>
<p>The <code>version</code> argument sets defaults for the number of hours in the lookback <span class="math inline">\(N\)</span> (<code>numHrs</code>), the minimum weight factor <span class="math inline">\(c_{min}\)</span> (<code>weightFactorMin</code>), and the number of digits to which the final data is truncated (<code>digits</code>).</p>
<ul>
<li>
<code>version='pm25'</code> (default)
<ul>
<li><code>numHrs &lt;- 12</code></li>
<li><code>weightFactorMin &lt;- 0.5</code></li>
<li><code>digits &lt;- 1</code></li>
</ul>
</li>
<li>
<code>version='ozone'</code>
<ul>
<li><code>numHrs &lt;- 8</code></li>
<li><code>weightFactorMin &lt;- NA</code></li>
<li><code>digits &lt;- 3</code></li>
</ul>
</li>
<li>
<code>version='pmAsian'</code>
<ul>
<li><code>numHrs &lt;- 3</code></li>
<li><code>weightFactorMin &lt;- 0.1</code></li>
<li><code>digits &lt;- 1</code></li>
</ul>
</li>
</ul>
<p>The default setting is <code>version='pm25'</code> since this is the parameter most commonly stored in <code>ws_monitor</code> objects.</p>
<p><code>version='ozone'</code> supports the O3 NowCast as described above.</p>
<p><code>version='pmAsian'</code> supports an alternative shorter-term NowCast as proposed here: <a href="https://aqicn.org/faq/2015-03-15/air-quality-nowcast-a-beginners-guide/" class="uri">https://aqicn.org/faq/2015-03-15/air-quality-nowcast-a-beginners-guide/</a></p>
<p>Although the NowCast algorithm itself supports PM10, we do not currently provide functionality for this parameter in the <code><a href="../reference/monitor_nowcast.html">monitor_nowcast()</a></code> function.</p>
<p>In the future we may allow manual override of the settings described above to allow for custom NowCast-type algorithms.</p>
</div>
</div>
<div id="nowcast-and-aqi-calculations" class="section level2">
<h2 class="hasAnchor">
<a href="#nowcast-and-aqi-calculations" class="anchor"></a>NowCast and AQI Calculations</h2>
<p>The EPA uses an <a href="https://www.airnow.gov/index.cfm?action=aqibasics.aqi">Air Quality Index</a> to put different pollutants on the same scale. From their site:</p>
<blockquote>
<p>Think of the AQI as a yardstick that runs from 0 to 500. The higher the AQI value, the greater the level of air pollution and the greater the health concern. For example, an AQI value of 50 represents good air quality with little potential to affect public health, while an AQI value over 300 represents hazardous air quality.</p>
</blockquote>
<p>We provide the <code><a href="../reference/monitor_aqi.html">monitor_aqi()</a></code> function to convert the PM2.5 data in a <code>ws_monitor</code> object into NowCast-based AQI values in the 0-500 range.</p>
</div>
<div id="examples" class="section level2">
<h2 class="hasAnchor">
<a href="#examples" class="anchor"></a>Examples</h2>
<p>The following examples demonstrate the functionality of <code><a href="../reference/monitor_nowcast.html">monitor_nowcast()</a></code> and specifics of its implementation.</p>
<div id="setup" class="section level3">
<h3 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h3>
<p>For the following examples we will use the Northwest Megafires data from the PWFSLSmoke package. In particular, we will look at PM2.5 data from Omak, WA, which was heavily impacted by smoke from wildfires during the second half of August, 2015:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/message">suppressPackageStartupMessages</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(PWFSLSmoke))

N_M &lt;-<span class="st"> </span><span class="kw"><a href="../reference/monitor_subset.html">monitor_subset</a></span>(Northwest_Megafires, <span class="dt">tlim=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">20150801</span>,<span class="dv">20150831</span>),
                      <span class="dt">timezone=</span><span class="st">"America/Los_Angeles"</span>)
Omak &lt;-<span class="st"> </span><span class="kw"><a href="../reference/monitor_subset.html">monitor_subset</a></span>(N_M, <span class="dt">monitorIDs=</span><span class="st">'530470013_01'</span>)
Omak_nowcast &lt;-<span class="st"> </span><span class="kw"><a href="../reference/monitor_nowcast.html">monitor_nowcast</a></span>(Omak)</code></pre></div>
<p><img src="NowCast_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
</div>
<div id="example-1-basic-formula-verification" class="section level3">
<h3 class="hasAnchor">
<a href="#example-1-basic-formula-verification" class="anchor"></a>Example 1: Basic Formula Verification</h3>
<p>In the code above we used the <code><a href="../reference/monitor_nowcast.html">monitor_nowcast()</a></code> function to calculate PM2.5 NowCast values for the Omak <code>ws_monitor</code> object. Let’s see if we can verify the function’s output for a single hour.</p>
<p>Below is the Omak PM2.5 data for the first 12 hours of 8/21/15. Let’s see if we can verify the accuracy of the NowCast value for the last hour in this series, 8/21/15 Hour 11.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Omak_2015_08_<span class="dv">21</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/monitor_subset.html">monitor_subset</a></span>(Omak, <span class="dt">tlim=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">2015082100</span>, <span class="dv">2015082111</span>))
(example1_df &lt;-<span class="st"> </span>Omak_2015_08_<span class="dv">21</span><span class="op">$</span>data)</code></pre></div>
<pre><code>              datetime 530470013_01
1  2015-08-21 00:00:00        123.3
2  2015-08-21 01:00:00         80.2
3  2015-08-21 02:00:00         49.3
4  2015-08-21 03:00:00        101.8
5  2015-08-21 04:00:00         93.7
6  2015-08-21 05:00:00        143.2
7  2015-08-21 06:00:00        215.4
8  2015-08-21 07:00:00        130.6
9  2015-08-21 08:00:00        129.2
10 2015-08-21 09:00:00         59.8
11 2015-08-21 10:00:00         27.4
12 2015-08-21 11:00:00         46.3</code></pre>
<p>First we’ll pull out just the values themselves, and reverse them so the most recent values come first (i.e. so the vector represents <span class="math inline">\(c_1\)</span>, <span class="math inline">\(c_2\)</span>, <span class="math inline">\(...\)</span>, <span class="math inline">\(c_N\)</span>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(example1_values &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rev">rev</a></span>(example1_df<span class="op">$</span><span class="st">`</span><span class="dt">530470013_01</span><span class="st">`</span>))</code></pre></div>
<pre><code> [1]  46.3  27.4  59.8 129.2 130.6 215.4 143.2  93.7 101.8  49.3  80.2 123.3</code></pre>
<p>Per the NowCast algorithm, we define <span class="math inline">\(w*\)</span> as <span class="math inline">\(\frac{c_{min}}{c_{max}}\)</span>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(w_star &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(example1_values)<span class="op">/</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(example1_values))</code></pre></div>
<pre><code>[1] 0.1272052</code></pre>
<p>We now define <span class="math inline">\(w\)</span> based on <span class="math inline">\(w^*\)</span> and the minimum weight factor; recall that <span class="math inline">\(w_{min}=\frac{1}{2}\)</span> for PM2.5:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(w &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(<span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, w_star))</code></pre></div>
<pre><code>[1] 0.5</code></pre>
<p>Thus, the numerator of the NowCast equation for Hour 11</p>
<p><span class="math display">\[
w^0c_1 + w^1c_2 + w^2c_3 + w^3c_4 + w^4c_5 + w^5c_6 + w^6c_7 + w^7c_8 + w^8c_9 + w^9c_{10} + w^{10}c_{11} + w^{11}c_{12}
\]</span></p>
<p>becomes the following:</p>
<p><span class="math inline">\(0.5^0 \times 46.3 + 0.5^1 \times 27.4 + 0.5^2 \times 59.8 + 0.5^3 \times 129.2 + 0.5^4 \times 130.6 + 0.5^5 \times 215.4\)</span> +<br><span class="math inline">\(0.5^6 \times 143.2 + 0.5^7 \times 93.7 + 0.5^8 \times 101.8 + 0.5^9 \times 49.3 + 0.5^{10} \times 80.2 + 0.5^{11} \times 123.3\)</span></p>
<p>which we can calculate in R as follows</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(numer &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(w<span class="op">^</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">11</span>)<span class="op">*</span>example1_values))</code></pre></div>
<pre><code>[1] 109.5958</code></pre>
<p>Meanwhile, the denominator</p>
<p><span class="math display">\[
w^0 + w^1 + w^2 + w^3 + w^4 + w^5 + w^6 + w^7 + w^8 + w^9 + w^{10} + w^{11}
\]</span></p>
<p>becomes the following:</p>
<p><span class="math inline">\(0.5^0 + 0.5^1 + 0.5^2 + 0.5^3 + 0.5^4 + 0.5^5 + 0.5^6 + 0.5^7 + 0.5^8 + 0.5^9 + 0.5^{10} + 0.5^{11}\)</span></p>
<p>which we can calculate in R as follows</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(denom &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(w<span class="op">^</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">11</span>)))</code></pre></div>
<pre><code>[1] 1.999512</code></pre>
<p>Dividing the numerator by the denominator gives a value of</p>
<pre><code>[1] 54.81126</code></pre>
<p>which we truncate to one decimal place for a final NowCast value of <strong>54.8</strong> for 8/21/15 Hour 11.</p>
<p>So how does this compare to our <code><a href="../reference/monitor_nowcast.html">monitor_nowcast()</a></code> output for the same hour?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/monitor_subset.html">monitor_subset</a></span>(Omak_nowcast, <span class="dt">tlim=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">2015082111</span>, <span class="dv">2</span>))<span class="op">$</span>data</code></pre></div>
<pre><code>             datetime 530470013_01
1 2015-08-21 11:00:00         54.8</code></pre>
<p>Right on!</p>
</div>
<div id="example-2-short-missing-data-period" class="section level3">
<h3 class="hasAnchor">
<a href="#example-2-short-missing-data-period" class="anchor"></a>Example 2: Short Missing Data Period</h3>
<p>So we have verified the calculation for a period with 12 valid hours. But how does the function handle missing data periods? Let’s take a look at a short period of missing data to find out.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Omak_2015_08_<span class="dv">24</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/monitor_subset.html">monitor_subset</a></span>(Omak, <span class="dt">tlim=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">2015082412</span>, <span class="dv">2015082423</span>))
(example2_df &lt;-<span class="st"> </span>Omak_2015_08_<span class="dv">24</span><span class="op">$</span>data)</code></pre></div>
<pre><code>              datetime 530470013_01
1  2015-08-24 12:00:00        461.7
2  2015-08-24 13:00:00        486.2
3  2015-08-24 14:00:00        510.4
4  2015-08-24 15:00:00        583.0
5  2015-08-24 16:00:00        645.7
6  2015-08-24 17:00:00        745.5
7  2015-08-24 18:00:00           NA
8  2015-08-24 19:00:00        711.0
9  2015-08-24 20:00:00        683.3
10 2015-08-24 21:00:00        589.8
11 2015-08-24 22:00:00        504.6
12 2015-08-24 23:00:00        478.5</code></pre>
<p>Here we see that the monitor data is missing for Hour 18. We want to verify that this hour is properly excluded from the NowCast calculation for subsequent hours. We also want to ensure that NowCast returns valid values for all hours in the vicinity, since all hours meet the minimum data availability requirements (i.e. two of three most recent hours valid).</p>
<div id="formula-verification" class="section level4">
<h4 class="hasAnchor">
<a href="#formula-verification" class="anchor"></a>Formula Verification</h4>
<p>Let’s see if we can verify the accuracy of the NowCast value for Hour 23.</p>
<p>We again begin by pulling out our vector of values <span class="math inline">\(c_1\)</span>, <span class="math inline">\(c_2\)</span>, <span class="math inline">\(...\)</span>, <span class="math inline">\(c_N\)</span></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(example2_values &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rev">rev</a></span>(example2_df<span class="op">$</span><span class="st">`</span><span class="dt">530470013_01</span><span class="st">`</span>))</code></pre></div>
<pre><code> [1] 478.5 504.6 589.8 683.3 711.0    NA 745.5 645.7 583.0 510.4 486.2 461.7</code></pre>
<p>and calculating <span class="math inline">\(w*\)</span> and <span class="math inline">\(w\)</span></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">w_star &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(example2_values, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">/</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(example2_values, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)
(w &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(<span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, w_star))</code></pre></div>
<pre><code>[1] 0.6193159</code></pre>
<p>This time our numerator and denominator should both exclude the 6th term, since <span class="math inline">\(c_6\)</span> is invalid. So we have</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">validIndexes &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(example2_values))
numer &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(w<span class="op">^</span>(validIndexes<span class="op">-</span><span class="dv">1</span>)<span class="op">*</span>example2_values[validIndexes])
denom &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(w<span class="op">^</span>(validIndexes<span class="op">-</span><span class="dv">1</span>))
numer<span class="op">/</span>denom</code></pre></div>
<pre><code>[1] 543.896</code></pre>
<p>We truncate the value above to one decimal place for a final NowCast value of <strong>543.8</strong> for 8/24/15 Hour 23.</p>
<p>So how does this compare to our <code><a href="../reference/monitor_nowcast.html">monitor_nowcast()</a></code> output for the same hour?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/monitor_subset.html">monitor_subset</a></span>(Omak_nowcast, <span class="dt">tlim=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">2015082423</span>, <span class="dv">2</span>))<span class="op">$</span>data</code></pre></div>
<pre><code>             datetime 530470013_01
1 2015-08-24 23:00:00        543.8</code></pre>
<p>Again, right on!</p>
</div>
<div id="missing-data-verification" class="section level4">
<h4 class="hasAnchor">
<a href="#missing-data-verification" class="anchor"></a>Missing Data Verification</h4>
<p>A quick look at the monitored data alongside the NowCast data shows that all NowCast hours are valid except for the c<sub>1</sub> moment when the monitoring data is also invalid.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">example2_df<span class="op">$</span>nowcast &lt;-<span class="st"> </span><span class="kw"><a href="../reference/monitor_subset.html">monitor_subset</a></span>(Omak_nowcast, <span class="dt">tlim=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">2015082412</span>, <span class="dv">2015082423</span>))<span class="op">$</span>data<span class="op">$</span><span class="st">`</span><span class="dt">530470013_01</span><span class="st">`</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(example2_df) &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"datetime"</span>, <span class="st">"monitored"</span>, <span class="st">"nowcast"</span>)
example2_df</code></pre></div>
<pre><code>              datetime monitored nowcast
1  2015-08-24 12:00:00     461.7   403.1
2  2015-08-24 13:00:00     486.2   444.7
3  2015-08-24 14:00:00     510.4   477.6
4  2015-08-24 15:00:00     583.0   530.3
5  2015-08-24 16:00:00     645.7   588.0
6  2015-08-24 17:00:00     745.5   666.8
7  2015-08-24 18:00:00        NA      NA
8  2015-08-24 19:00:00     711.0   696.4
9  2015-08-24 20:00:00     683.3   688.9
10 2015-08-24 21:00:00     589.8   636.1
11 2015-08-24 22:00:00     504.6   569.4
12 2015-08-24 23:00:00     478.5   543.8</code></pre>
</div>
</div>
<div id="example-3-long-missing-data-period" class="section level3">
<h3 class="hasAnchor">
<a href="#example-3-long-missing-data-period" class="anchor"></a>Example 3: Long Missing Data Period</h3>
<p>We now look at a longer period of missing data, from the day prior on 8/23/15.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Omak_2015_08_<span class="dv">23</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/monitor_subset.html">monitor_subset</a></span>(Omak, <span class="dt">tlim=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">2015082312</span>, <span class="dv">2015082323</span>))
(example3_df &lt;-<span class="st"> </span>Omak_2015_08_<span class="dv">23</span><span class="op">$</span>data)</code></pre></div>
<pre><code>              datetime 530470013_01
1  2015-08-23 12:00:00        711.8
2  2015-08-23 13:00:00        734.0
3  2015-08-23 14:00:00        744.6
4  2015-08-23 15:00:00        763.8
5  2015-08-23 16:00:00           NA
6  2015-08-23 17:00:00           NA
7  2015-08-23 18:00:00           NA
8  2015-08-23 19:00:00           NA
9  2015-08-23 20:00:00           NA
10 2015-08-23 21:00:00        238.6
11 2015-08-23 22:00:00        149.9
12 2015-08-23 23:00:00        149.5</code></pre>
<p>Here we see that the monitored data is missing for Hours 16-20. We again want to verify that these hours are properly excluded from the NowCast calculation for subsequent hours. This time we also want to ensure that NowCast returns invalid values for hours in which the minimum data availability requirements are not met (i.e. two of three most recent hours valid).</p>
<div id="formula-verification-1" class="section level4">
<h4 class="hasAnchor">
<a href="#formula-verification-1" class="anchor"></a>Formula Verification</h4>
<p>Let’s see if we can verify the accuracy of the NowCast value for Hour 23.</p>
<p>We again begin by pulling out our vector of values <span class="math inline">\(c_1\)</span>, <span class="math inline">\(c_2\)</span>, <span class="math inline">\(...\)</span>, <span class="math inline">\(c_N\)</span></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(example3_values &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rev">rev</a></span>(example3_df<span class="op">$</span><span class="st">`</span><span class="dt">530470013_01</span><span class="st">`</span>))</code></pre></div>
<pre><code> [1] 149.5 149.9 238.6    NA    NA    NA    NA    NA 763.8 744.6 734.0 711.8</code></pre>
<p>and calculating <span class="math inline">\(w*\)</span> and <span class="math inline">\(w\)</span></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">w_star &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(example3_values, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">/</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(example3_values, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)
(w &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(<span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, w_star))</code></pre></div>
<pre><code>[1] 0.5</code></pre>
<p>This time our numerator and denominator should both exclude the 4th-8th terms, since <span class="math inline">\(c_4\)</span>, <span class="math inline">\(c_5\)</span>, <span class="math inline">\(c_6\)</span>, <span class="math inline">\(c_7\)</span> and <span class="math inline">\(c_8\)</span> are invalid. So we have</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">validIndexes &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(example3_values))
numer &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(w<span class="op">^</span>(validIndexes<span class="op">-</span><span class="dv">1</span>)<span class="op">*</span>example3_values[validIndexes])
denom &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(w<span class="op">^</span>(validIndexes<span class="op">-</span><span class="dv">1</span>))
numer<span class="op">/</span>denom</code></pre></div>
<pre><code>[1] 164.7973</code></pre>
<p>We truncate the value above to one decimal place for a final NowCast value of <strong>164.7</strong> for 8/23/15 Hour 23.</p>
<p>So how does this compare to our <code><a href="../reference/monitor_nowcast.html">monitor_nowcast()</a></code> output for the same hour?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/monitor_subset.html">monitor_subset</a></span>(Omak_nowcast, <span class="dt">tlim=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">2015082323</span>, <span class="dv">2</span>))<span class="op">$</span>data</code></pre></div>
<pre><code>             datetime 530470013_01
1 2015-08-23 23:00:00        164.7</code></pre>
<p>Again, right on!</p>
</div>
<div id="missing-data-verification-1" class="section level4">
<h4 class="hasAnchor">
<a href="#missing-data-verification-1" class="anchor"></a>Missing Data Verification</h4>
<p>Now we’ll look at the monitored data alongside the NowCast data to see how the validity of the NowCast data was affected by the missing monitored hours.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">example3_df<span class="op">$</span>nowcast &lt;-<span class="st"> </span><span class="kw"><a href="../reference/monitor_subset.html">monitor_subset</a></span>(Omak_nowcast, <span class="dt">tlim=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">2015082312</span>, <span class="dv">2015082323</span>))<span class="op">$</span>data<span class="op">$</span><span class="st">`</span><span class="dt">530470013_01</span><span class="st">`</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(example3_df) &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"datetime"</span>, <span class="st">"monitored"</span>, <span class="st">"nowcast"</span>)
example3_df</code></pre></div>
<pre><code>              datetime monitored nowcast
1  2015-08-23 12:00:00     711.8   667.8
2  2015-08-23 13:00:00     734.0   700.9
3  2015-08-23 14:00:00     744.6   722.8
4  2015-08-23 15:00:00     763.8   743.3
5  2015-08-23 16:00:00        NA      NA
6  2015-08-23 17:00:00        NA      NA
7  2015-08-23 18:00:00        NA      NA
8  2015-08-23 19:00:00        NA      NA
9  2015-08-23 20:00:00        NA      NA
10 2015-08-23 21:00:00     238.6      NA
11 2015-08-23 22:00:00     149.9   185.1
12 2015-08-23 23:00:00     149.5   164.7</code></pre>
<p>There’s a lot going on here so let’s walk through the data one step at a time.</p>
<p><strong>Hours 12-15</strong>: NowCast data is valid because the monitored data is valid for all of the three most recent hours.<br>
Status: <span style="color:limegreen">GOOD</span></p>
<p><strong>Hour 16</strong>: This is the first hour for which the monitored data is invalid. NowCast should also return invalid for this c<sub>1</sub> timestep.<br>
Status: <span style="color:limegreen">GOOD</span></p>
<p><strong>Hour 17</strong>: This NowCast value is invalid because the monitored data is only valid for one of the three most recent hours (Hour 15).<br>
Status: <span style="color:limegreen">GOOD</span></p>
<p><strong>Hours 18-20</strong>: NowCast is invalid since the monitored data is valid for none of the three most recent hours.<br>
Status: <span style="color:limegreen">GOOD</span></p>
<p><strong>Hour 21</strong>: This is the first hour for which the monitored data is valid again. However, NowCast still returns an invalid value this hour since the monitored data is only valid for one of the three most recent hours (Hour 21).<br>
Status: <span style="color:limegreen">GOOD</span></p>
<p><strong>Hour 22</strong>: This is the first hour for which the NowCast data is valid again. This is because the monitored data is again valid for two of the three most recent hours (Hours 21 and 22).<br>
Status: <span style="color:limegreen">GOOD</span></p>
<p><strong>Hour 23</strong>: NowCast data is valid because the monitored data is valid for all of the three most recent hours. Status: <span style="color:limegreen">GOOD</span></p>
<p>So, it appears the <code><a href="../reference/monitor_nowcast.html">monitor_nowcast()</a></code> returns data that has been correctly validated according to the NowCast algorithm and associated data availability requirements.</p>
</div>
<div id="does-most-recent-include-current" class="section level4">
<h4 class="hasAnchor">
<a href="#does-most-recent-include-current" class="anchor"></a>Does “most recent” include “current”?</h4>
<p>A subtle point about the <code><a href="../reference/monitor_nowcast.html">monitor_nowcast()</a></code> function which falls out of the example above: <strong>the “current” hour is considered to be a part of the three “most recent clock hours”</strong>. This may seem strange at first, but to understand why we chose this approach, one must think about how the data is captured and how measurement timestamps correspond to the period they actually represent.</p>
<p>For particle pollution, measurements typically represent the mass of particles that accumulate on a filter during a set period of time, e.g. the past hour. Measurements come in at the end of the hour, but these measurements aren’t necessarily representative of conditions at the exact times of the measurements. Instead, they are actually representative of concentrations <strong>during the previous clock hour</strong>. For example, if an hourly measurement comes in at 12:00, the measurement is actually representative of data during Hour 11, <strong>NOT</strong> Hour 12. So we call the 12:00 measurement the Hour 11 data point.</p>
<p>This is really just a labeling convention, and it is no different from how we treat other datasets. For example, suppose you wanted to take an average of the low temperatures for every day in July. You would have to wait until August 1st to do so, since the temperature might still be dropping at the end of the day on July 31st. But does this mean you would call this value the average low temperature for August, since it wasn’t calculated until August? Of course not: the data belongs to July, even if it couldn’t be calculated until August. It is no different with particle pollution: the Hour 11 data belongs to Hour 11, even if it wasn’t calculated until 12:00. As a result of this convention, timestamps are usually an entire hour (or more) earlier than the time the measurements were actually taken (exact differences depend on several factors).</p>
<p>Another reason for including the “current” hour in the NowCast “three most recent hours” is for speed of updates. Suppose it is 12:04, and a measurement just came in at 12:00 (the Hour 11 measurement). It would be inappropriate to wait until 13:00 to calculate the updated NowCast value. For this reason, we calculate NowCast values using the monitored data for the “current” hour and the <span class="math inline">\(N-1\)</span> prior hours.</p>
</div>
</div>
<div id="example-4-includeshortterm-argument" class="section level3">
<h3 class="hasAnchor">
<a href="#example-4-includeshortterm-argument" class="anchor"></a>Example 4: <code>includeShortTerm</code> argument</h3>
<p>For our final NowCast example we will explore the <code>includeShortTerm</code> argument, including a demonstration of why it defaults to <code>FALSE</code>.</p>
<p>Suppose we wanted to know the NowCast values for Omak for the first half of 8/25/15, since concentrations were extremely high at the time. A normal course of action might be to create a <code>ws_monitor</code> object for Omak for 8/25/15:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tlim &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">2015082500</span>,<span class="dv">2015082523</span>)
Omak2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/monitor_subset.html">monitor_subset</a></span>(Northwest_Megafires, <span class="dt">tlim=</span>tlim, <span class="dt">monitorIDs =</span> <span class="st">'530470013_01'</span>)
Omak2_nowcast &lt;-<span class="st"> </span><span class="kw"><a href="../reference/monitor_nowcast.html">monitor_nowcast</a></span>(Omak2)
Omak2_nowcast<span class="op">$</span>data</code></pre></div>
<pre><code>              datetime 530470013_01
1  2015-08-25 00:00:00           NA
2  2015-08-25 01:00:00           NA
3  2015-08-25 02:00:00           NA
4  2015-08-25 03:00:00           NA
5  2015-08-25 04:00:00           NA
6  2015-08-25 05:00:00           NA
7  2015-08-25 06:00:00           NA
8  2015-08-25 07:00:00           NA
9  2015-08-25 08:00:00           NA
10 2015-08-25 09:00:00           NA
11 2015-08-25 10:00:00           NA
12 2015-08-25 11:00:00        373.7
13 2015-08-25 12:00:00        370.0
14 2015-08-25 13:00:00        364.6
15 2015-08-25 14:00:00           NA
16 2015-08-25 15:00:00           NA
17 2015-08-25 16:00:00           NA
18 2015-08-25 17:00:00           NA
19 2015-08-25 18:00:00           NA
20 2015-08-25 19:00:00           NA
21 2015-08-25 20:00:00           NA
22 2015-08-25 21:00:00           NA
23 2015-08-25 22:00:00           NA
24 2015-08-25 23:00:00        120.3</code></pre>
<p>Unfortunately, the first 12 hours are invalid. But you read in the documentation that <code>includeShortTerm=TRUE</code> will return values for the second valid hour onwards. So you try again, this time setting <code>includeShortTerm=TRUE</code>. Let’s check it out.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Omak2_nowcast &lt;-<span class="st"> </span><span class="kw"><a href="../reference/monitor_nowcast.html">monitor_nowcast</a></span>(Omak2, <span class="dt">includeShortTerm =</span> <span class="ot">TRUE</span>)
Omak2_nowcast<span class="op">$</span>data</code></pre></div>
<pre><code>              datetime 530470013_01
1  2015-08-25 00:00:00           NA
2  2015-08-25 01:00:00        456.3
3  2015-08-25 02:00:00        451.0
4  2015-08-25 03:00:00        420.7
5  2015-08-25 04:00:00        388.4
6  2015-08-25 05:00:00        389.9
7  2015-08-25 06:00:00        388.9
8  2015-08-25 07:00:00        382.7
9  2015-08-25 08:00:00        378.1
10 2015-08-25 09:00:00        375.9
11 2015-08-25 10:00:00        374.7
12 2015-08-25 11:00:00        373.7
13 2015-08-25 12:00:00        370.0
14 2015-08-25 13:00:00        364.6
15 2015-08-25 14:00:00           NA
16 2015-08-25 15:00:00           NA
17 2015-08-25 16:00:00           NA
18 2015-08-25 17:00:00           NA
19 2015-08-25 18:00:00           NA
20 2015-08-25 19:00:00           NA
21 2015-08-25 20:00:00           NA
22 2015-08-25 21:00:00           NA
23 2015-08-25 22:00:00           NA
24 2015-08-25 23:00:00        120.3</code></pre>
<p>Nice. We were able to get NowCast values for all but the first hour!</p>
<p>But there’s a problem lurking. Setting <code>includeShortTerm=TRUE</code> caused the <code><a href="../reference/monitor_nowcast.html">monitor_nowcast()</a></code> function to treat hours prior to Hour 0 as invalid. <strong>It has no idea that valid data is available for this period.</strong></p>
<p>As an experiment, let’s see how the NowCast values would look if we calculated them from a larger dataset that includes the data prior to 8/25/15 Hour 0.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">example4_df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/monitor_subset.html">monitor_subset</a></span>(Omak_nowcast, <span class="dt">tlim=</span>tlim)<span class="op">$</span>data
example4_df<span class="op">$</span>shortTerm_T &lt;-<span class="st"> </span>Omak2_nowcast<span class="op">$</span>data<span class="op">$</span><span class="st">`</span><span class="dt">530470013_01</span><span class="st">`</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(example4_df) &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"datetime"</span>, <span class="st">"fullDataset"</span>, <span class="st">"shortTerm"</span>)
example4_df</code></pre></div>
<pre><code>              datetime fullDataset shortTerm
1  2015-08-25 00:00:00       512.5        NA
2  2015-08-25 01:00:00       485.6     456.3
3  2015-08-25 02:00:00       466.1     451.0
4  2015-08-25 03:00:00       410.7     420.7
5  2015-08-25 04:00:00       372.3     388.4
6  2015-08-25 05:00:00       382.7     389.9
7  2015-08-25 06:00:00       384.7     388.9
8  2015-08-25 07:00:00       376.4     382.7
9  2015-08-25 08:00:00       373.5     378.1
10 2015-08-25 09:00:00       374.9     375.9
11 2015-08-25 10:00:00       374.6     374.7
12 2015-08-25 11:00:00       373.7     373.7
13 2015-08-25 12:00:00       370.0     370.0
14 2015-08-25 13:00:00       364.6     364.6
15 2015-08-25 14:00:00          NA        NA
16 2015-08-25 15:00:00          NA        NA
17 2015-08-25 16:00:00          NA        NA
18 2015-08-25 17:00:00          NA        NA
19 2015-08-25 18:00:00          NA        NA
20 2015-08-25 19:00:00          NA        NA
21 2015-08-25 20:00:00          NA        NA
22 2015-08-25 21:00:00          NA        NA
23 2015-08-25 22:00:00          NA        NA
24 2015-08-25 23:00:00       120.3     120.3</code></pre>
<p>While not too extreme, we see differences in the NowCast values calculated by the different approaches, even as late as the 11th hour of the period. As expected, the values match from the 12th hour on.</p>
<p>The discrepancies displayed above are why, by default, <code>includeShortTerm=FALSE</code>. It should be used only when necessary, and with an understanding that the first <span class="math inline">\(N\)</span> hours’ values might not necessarily be true NowCast values.</p>
<p>If it exists, we recommend always grabbing an extra day of data at the beginning of the period if you think you might want to calculate NowCast values on a dataset.</p>
</div>
<div id="example-5-aqi" class="section level3">
<h3 class="hasAnchor">
<a href="#example-5-aqi" class="anchor"></a>Example 5: AQI</h3>
<p>Finally, we’ll perform a brief demonstration of the <code><a href="../reference/monitor_aqi.html">monitor_aqi()</a></code> function using data from a prior example.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aqi &lt;-<span class="st"> </span><span class="kw"><a href="../reference/monitor_aqi.html">monitor_aqi</a></span>(Omak)
example5_df &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="st">"datetime"</span>=Omak<span class="op">$</span>data<span class="op">$</span>datetime,
                          <span class="st">"monitored"</span>=Omak<span class="op">$</span>data<span class="op">$</span><span class="st">`</span><span class="dt">530470013_01</span><span class="st">`</span>,
                          <span class="st">"aqi"</span>=aqi<span class="op">$</span>data<span class="op">$</span><span class="st">`</span><span class="dt">530470013_01</span><span class="st">`</span>)
example5_df &lt;-<span class="st"> </span>example5_df[<span class="dv">500</span><span class="op">:</span><span class="dv">650</span>,]
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(example5_df<span class="op">$</span>datetime, example5_df<span class="op">$</span>monitored, <span class="dt">xlab=</span><span class="st">'Date'</span>, <span class="dt">ylab=</span><span class="st">''</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(example5_df<span class="op">$</span>datetime, example5_df<span class="op">$</span>aqi, <span class="dt">col=</span><span class="st">"blue"</span>)</code></pre></div>
<p><img src="NowCast_files/figure-html/unnamed-chunk-27-1.png" width="672"></p>
<!-- TODO: clean up and beef up this example -->
<!-- ## Test Dataset -->
<!-- > Under "test datasets" I'd like to see a simple CSV file with two columns: pm25_input, expected_output -->
<!-- TODO: add test datasets -->
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#what-is-nowcast">What is NowCast?</a></li>
      <li><a href="#the-nowcast-algorithm-reff-method">The NowCast Algorithm (Reff Method)</a></li>
      <li><a href="#algorithm-expansion">Algorithm Expansion</a></li>
      <li><a href="#implementation-details">Implementation Details</a></li>
      <li><a href="#nowcast-and-aqi-calculations">NowCast and AQI Calculations</a></li>
      <li><a href="#examples">Examples</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Jonathan Callahan, Rohan Aras, Zach Dingels, Jon Hagg, Jimin Kim, Hans Martin, Helen Miller, Spencer Pease, Rex Thompson, Alice Yang.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
